name: Daily ArXiv Agent

on:
  schedule:
    # 每天 UTC 时间 00:00 运行 (相当于北京时间早上 08:00)
    - cron: '0 0 * * *'
  # 允许手动点击按钮触发测试
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest
    
    # 设置时区为上海，方便日志查看
    env:
      TZ: Asia/Shanghai

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 安装 Python 3.9
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip' # 开启缓存，加快安装速度

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      # 4. 生成用户画像 (注意：我们要把它写到 code 目录下，或者让脚本能读到)
      # 为了保险，我们进入 code 目录去操作
      - name: Create User Profile from Secret
        env:
          MY_PROFILE: ${{ secrets.USER_PROFILE_JSON }}
        run: |
          # 确保 code 目录存在 (虽然拉取代码后肯定有，但为了保险)
          # 这里我们将 json 写入到 code/user_profile.json，这样脚本在同级目录下能直接读取
          python -c "import os; open('code/user_profile.json', 'w', encoding='utf-8').write(os.environ['MY_PROFILE'])"
          
      # 5. 运行脚本 (并将 Secrets 注入环境变量)
      - name: Run ArXiv Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          ARXIV_QUERY: ${{ secrets.ARXIV_QUERY }}
          USER_INTEREST: ${{ secrets.USER_INTEREST }}
          # 其他参数使用默认值，或者你也可以在这里覆盖
          MAX_RESULTS: 15
          ARXIV_DAYS: 1
        working-directory: ./code
        run: python main.py
